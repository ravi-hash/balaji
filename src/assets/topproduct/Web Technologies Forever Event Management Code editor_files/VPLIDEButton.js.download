// This file is part of VPL for Moodle - http://vpl.dis.ulpgc.es/
//
// VPL for Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// VPL for Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with VPL for Moodle.  If not, see <http://www.gnu.org/licenses/>.

/**
 * IDE Buttons
 * @package mod_vpl
 * @copyright 2016 Juan Carlos Rodríguez-del-Pino
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @author Juan Carlos Rodríguez-del-Pino <jcrodriguez@dis.ulpgc.es>
 */
(function() {
    if (!window.VPL_IDEButtons) {
        VPL_IDEButtons = function(menu_element, isOptionAllowed, max_files = 0) {
            var self = this;
            var buttons = {};

            this.noAdded = function(button) {
                return !buttons[button];
            };
            this.setText = function(button, icon, title) {
                if (self.noAdded(button)) {
                    return;
                }
                if (!icon) {
                    icon = buttons[button].icon;
                }
                if (!title) {
                    title = buttons[button].title;
                }
                if (!title) {
                    title = VPL_Util.str(icon);
                }
                buttons[button].icon = icon;
                buttons[button].title = title;
                if (buttons[button].hasOwnProperty('key')) {
                    title += ' (' + buttons[button].key + ')';
                }
                $JQVPL('#vpl_ide_' + button).attr('title', title);
                $JQVPL('#vpl_ide_' + button + ' i').replaceWith(VPL_Util.gen_icon(icon, 'sm'));
            };
            this.add = function(button) {
                if (typeof button === 'string') {
                    var name = button;
                    button = {
                        'name': name
                    };
                }
                if (!isOptionAllowed(button.name)) {
                    return;
                }
                if (!button.hasOwnProperty('icon')) {
                    button.icon = button.name;
                }
                if (!button.hasOwnProperty('active')) {
                    button.active = true;
                }
                if (!button.hasOwnProperty('editorName')) {
                    button.editorName = button.name;
                }
                if (!button.hasOwnProperty('originalAction')) {
                    button.originalAction = VPL_Util.doNothing;
                }
                if (self.noAdded(button)) {
                    buttons[button.name] = button;
                } else {
                    throw "Button already set " + button.name;
                }
                self.setAction(button.name, button.originalAction);
                if (button.hasOwnProperty('bindKey')) {
                    button.command = {
                        name: button.editorName,
                        bindKey: button.bindKey,
                        exec: button.action
                    };
                }
            };
            this.getHTML = function(button) {
                if (self.noAdded(button)) {
                    return '';
                } else {
                    var html = "<a type='button' id='vpl_ide_" + button + "' href='#' title='" + VPL_Util.str(button) + "' ";
                    switch (button) {
                        case 'filelist':
                            html += "class='btn' " + ">File List";
                            break;
                        case 'save':
                            html += "class='btn btn-success' ";
                            if (max_files > 1) {
                                html += ">Save All";
                            } else {
                                html += ">Save";
                            }
                            break;
                        case 'outline':
                            html += "class='btn' " + ">Outline";
                            break;
                        case 'run':
                            html += "class='btn' " + ">Compile & Run";
                            break;
                        case 'evaluate':
                            html += "class='btn' " + ">Evaluate";
                            break;
                        case 'submit':
                            html += "class='btn' " + ">Submit";
                            break;
                        case 'resetsubmission':
                            html += "class='btn' " + ">Reset";
                            break;
                        case 'fullscreen':
                            html += "class='btn' " + ">Full screen";
                            break;
                        case 'description':
                            html += "class='btn ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only' " + ">Description";
                            break;
                        default:
                            html += "class='btn'>" + button;
                    }
                    html += "</a>";
                    return html;
                }
            };

            this.enable = function(button, active) {
                if (self.noAdded(button)) {
                    return '';
                }
                if(active){
                    $('#vpl_ide_' + button).removeAttr("tabindex");
                }else{
                    $('#vpl_ide_' + button).attr("tabindex","-1");
                }
                buttons[button].active = active;
                $JQVPL('#vpl_ide_' + button).button(active ? 'enable' : 'disable');
            };
            this.setAction = function(button, action) {
                if (self.noAdded(button)) {
                    return;
                }
                buttons[button].originalAction = action;
                buttons[button].action = function() {
                    if (buttons[button].active) {
                        action();
                    }
                };
            };
            this.getAction = function(button) {
                if (self.noAdded(button)) {
                    return VPL_Util.doNothing;
                }
                return buttons[button].action;
            };
            this.launchAction = function(button) {
                if (self.noAdded(button)) {
                    return;
                }
                buttons[button].originalAction();
            };
            this.setGetkeys = function(editor) {
                if (editor) {
                    var commands = editor.commands.commands;
                    var platform = editor.commands.platform;
                    for (var button in buttons) {
                        var editorName = buttons[button].editorName;
                        if (commands[editorName] && commands[editorName].bindKey && !buttons[button].Key) {
                            buttons[button].key = commands[editorName].bindKey[platform];
                            self.setText(button);
                        } else {
                            if (buttons[button].bindKey) {
                                if (!buttons[button].hasOwnProperty('key')) {
                                    buttons[button].key = buttons[button].bindKey[platform];
                                    self.setText(button);
                                }
                            }
                        }
                    }
                }
            };
            this.getShortcuts = function(editor) {
                var html = '<ul>';
                for (var button in buttons) {
                    if (buttons[button].hasOwnProperty('key')) {
                        html += '<li>';
                        html += buttons[button].title + ' (' + buttons[button].key + ')';
                        html += '</li>';
                    }
                }
                html += '</ul>';
                if (editor) {
                    html += '<h5>' + VPL_Util.str('edit') + '</h5>';
                    var commands = editor.commands.commands;
                    var platform = editor.commands.platform;
                    html += '<ul>';
                    for (var editorName in commands) {
                        if (commands[editorName].hasOwnProperty('bindKey') && commands[editorName].bindKey[platform] > '') {
                            html += '<li>';
                            html += editorName + ' (' + commands[editorName].bindKey[platform] + ')';
                            html += '</li>';
                        }
                    }
                    html += '</ul>';
                }
                return html;
            };
            $JQVPL(menu_element).on("click", "a", function(event) {
                var button = $JQVPL(this).attr('id');
                if (typeof button === 'string') {
                    button = button.replace('vpl_ide_', '');
                } else {
                    event.stopPropagation();
                    return false;
                }
                if (self.noAdded(button)) {
                    return;
                }
                var action = self.getAction(button);
                if (button != 'import') {
                    setTimeout(action, 10);
                } else {
                    action();
                    event.stopPropagation();
                    return false;
                }
            });

            $JQVPL('body').on('keydown', function(event) {
                var check = false;
                var strkey = '';
                if (event.shiftKey) {
                    strkey += 'shift-';
                }
                if (event.altKey) {
                    strkey += 'alt-';
                    check = true;
                }
                if (event.ctrlKey) {
                    strkey += 'ctrl-';
                    check = true;
                }
                if (event.metaKey) {
                    strkey += 'meta-';
                    check = true;
                }
                if (event.which >= 112 && event.which <= 123) {
                    strkey += 'f' + (event.which - 111);
                    check = true;
                } else {
                    var char = String.fromCharCode(event.which).toLowerCase();
                    if (char < 'a' || char > 'z') {
                        check = false;
                    } else {
                        strkey += char;
                    }
                }
                if (check) {
                    for (var button in buttons) {
                        if (buttons[button].hasOwnProperty('key')) {
                            if (strkey == buttons[button].key.toLowerCase()) {
                                event.preventDefault();
                                event.stopImmediatePropagation();
                                buttons[button].action();
                                return false;
                            }
                        }
                    }
                }
            });
            this.multiple = function(v, m) {
                return v - (v % m);
            };
            (function() {
                var start = 0;
                var lastLap = 0;
                var interval = false;
                var hour = 60 * 60;
                var day = hour * 24;
                var cssclases = 'vpl_buttonleft_orange vpl_buttonleft_red vpl_buttonleft_black';
                var show = false;
                var element = null;
                var precision = 5;
                var checkt = 1000;
                var timeLeft = 0;
                var update = function() {
                    var now = self.multiple(VPL_Util.getCurrentTime(), precision);
                    if (now == lastLap || element == null) {
                        return;
                    }
                    lastLap = now;
                    var tl = timeLeft - (lastLap - start);
                    var thtml = VPL_Util.gen_icon('timeleft');
                    if (show) {
                        thtml += ' ' + VPL_Util.getTimeLeft(tl);
                    }
                    //vpl timer code
                    timercolor = '#4CAF50';
                    timervpl = document.getElementById('vpl_ide_timeleft');
                    timervpl.onmouseover = function(e) {
                        timervpl.style.backgroundColor = '#4CAF50';
                    };

                    document.getElementById('vpl_ide_timeleft').style.backgroundColor = '#4CAF50';
                    var cssclass = '';
                    if (tl <= 0) {
                        cssclass = 'vpl_buttonleft_black';
                        document.getElementById('vpl_ide_timeleft').style.backgroundColor = '#F44336';
                        if (tl >= -1) {
                            //    document.getElementById('vpl_ide_timeleft').style.display='none';
                            document.getElementById("vpl_ide_timeleft").innerHTML = "<blink id=\"vpl_timeout_msg\" class=\"blinking\">Time is Up!...</blink>";
                            document.getElementById('vpl_ide_timeleft').classList.remove('ui-state-default');

                        }
                    } else if (tl <= 5 * 60) {
                        //   cssclass = 'vpl_buttonleft_red';
                        cssclass = 'vpl_buttonleft_#F44336';
                        document.getElementById('vpl_ide_timeleft').style.backgroundColor = '#F44336';
                        timercolor = '#F44336';
                    } else if (tl <= 15 * 60) {
                        cssclass = 'vpl_buttonleft_orange';
                        document.getElementById('vpl_ide_timeleft').style.backgroundColor = 'orange';
                        timercolor = 'orange';
                    }
                    element.html(thtml);
                    element.removeClass(cssclases).addClass(cssclass);

                    // document.getElementById('vpl_ide_timeleft').classList.remove('ui-state-focus');
                    document.getElementById('vpl_ide_timeleft').classList.remove('ui-state-default');
                    document.getElementById('vpl_ide_timeleft').style.color = "white"; //.classList.remove('ui-state-focus');

                    timervpl.onclick = function() {
                        timervpl.classList.remove('ui-state-focus');
                        timervpl.classList.remove('ui-state-hover');
                        timervpl.classList.remove('ui-state-active');
                        //= timercolor;
                    };
                    timervpl.onmouseover = function(e) {
                        timervpl.classList.remove('ui-state-focus');
                        timervpl.classList.remove('ui-state-hover');
                        timervpl.classList.remove('ui-state-active');
                    };
                    timervpl.onmouseout = function(e) {
                        timervpl.classList.remove('ui-state-focus');
                        timervpl.classList.remove('ui-state-hover');
                        timervpl.classList.remove('ui-state-active');
                    };
                    timervpl.onmouseup = function(e) {
                        timervpl.classList.remove('ui-state-focus');
                        timervpl.classList.remove('ui-state-hover');
                        timervpl.classList.remove('ui-state-active');
                    };
                    timervpl.onmousedown = function(e) {
                        timervpl.classList.remove('ui-state-focus');
                        timervpl.classList.remove('ui-state-hover');
                        timervpl.classList.remove('ui-state-active');
                    };
                };
                self.toggleTimeLeft = function() {
                    show = !show;
                    lastLap = false;
                    update();
                };
                self.setTimeLeft = function(options) {
                    element = $JQVPL('#vpl_ide_timeleft span');
                    if (interval != false) {
                        clearInterval(interval);
                        interval = false;
                    }
                    if (options.hasOwnProperty('timeLeft')) {
                        $JQVPL('#vpl_ide_timeleft').show();
                        precision = 5;
                        checkt = 1000;
                        timeLeft = options.timeLeft;
                        if (timeLeft > hour) {
                            precision = 60;
                            checkt = 5000;
                        }
                        if (timeLeft > day) {
                            precision = 5 * 60;
                        }
                        var sync = timeLeft % precision;
                        timeLeft = self.multiple(timeLeft, precision);
                        start = self.multiple(VPL_Util.getCurrentTime(), precision);
                        lastLap = start - 1;
                        update();
                        setTimeout(() => {
                            interval = setInterval(update, checkt);
                        }, sync * 1000);
                    } else {
                        $JQVPL('#vpl_ide_timeleft').hide();
                    }
                };
            })();
        };
    }
})();